<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản lý bàn - LumiScan</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome cho icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SockJS và STOMP.js cho WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <audio id="notificationSound" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" preload="auto"></audio> <!-- Thay bằng file âm thanh của bạn -->
    <style>
        /* Custom styles cho mobile và animations */
        .table-card {
            transition: all 0.3s ease;
        }
        .table-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .status-toggle {
            transition: all 0.3s ease;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            max-width: 80vw; /* Responsive trên mobile */
            word-wrap: break-word;
        }
        .highlight {
            border: 2px solid #ef4444;
            background-color: #fef2f2;
            animation: pulse 1s infinite; /* Animation cho highlight */
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        /* Mobile-specific: Ensure buttons are touch-friendly */
        button, .table-card {
            min-height: 44px; /* iOS touch target */
        }
    </style>
</head>
<body style="background: #d7e0fa;" class="min-h-screen font-sans">
<!-- Header: Rounded, not sticky -->
<header class="bg-white shadow-sm mx-4 mt-4 rounded-2xl">
    <div class="px-4 py-3 max-w-screen-sm mx-auto">
        <div class="flex justify-between items-center">
            <div class="flex items-center">
                <a href="/employee/dashboard" class="mr-3 p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-arrow-left text-red-600 text-lg"></i>
                </a>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Quản lý bàn</h1>
                    <p class="text-xs text-gray-500">Nhân viên: <span th:text="${#authentication.name}">User</span></p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800" th:text="${activeTables}">0</div>
                    <div class="text-xs text-gray-500">Bàn hoạt động</div>
                </div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content: Responsive grid và list -->
<main class="px-4 py-4 max-w-screen-sm mx-auto pb-20">
    <!-- Stats Cards: Grid responsive -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-white rounded-2xl p-4 shadow-sm table-card">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center mr-3">
                    <i class="fas fa-table text-blue-600"></i>
                </div>
                <div>
                    <div class="text-lg font-bold text-gray-800" th:text="${totalTables}">0</div>
                    <div class="text-xs text-gray-500">Tổng bàn</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-sm table-card">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mr-3">
                    <i class="fas fa-check-circle text-green-600"></i>
                </div>
                <div>
                    <div class="text-lg font-bold text-gray-800" th:text="${activeTables}">0</div>
                    <div class="text-xs text-gray-500">Đang hoạt động</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables List: Vertical stack, touch-friendly -->
    <div th:each="table : ${tables}" id="table-[[${table.tableNumber}]]" class="bg-white rounded-2xl p-4 mb-4 shadow-sm table-card">
        <div class="flex justify-between items-center">
            <div class="flex-1">
                <div class="flex items-center mb-2">
                    <h3 class="text-lg font-semibold text-gray-800 mr-3">Bàn [[${table.tableNumber}]]</h3>
                    <span th:if="${table.status == 'available'}" 
                          class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                        Trống
                    </span>
                    <span th:if="${table.status == 'occupied'}" 
                          class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
                        Đang dùng
                    </span>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <!-- QR Code Button -->
                <button th:if="${table.qrCode != null and !#strings.isEmpty(table.qrCode)}" 
                        th:data-qr-path="${table.qrCode}"
                        onclick="showQR(this.getAttribute('data-qr-path'))"
                        class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center hover:bg-indigo-200 transition-all">
                    <i class="fas fa-qrcode text-indigo-600 text-sm"></i>
                </button>
                <!-- Toggle Status Button -->
                <form th:action="@{/tables/toggle/{id}(id=${table.id})}" method="post" class="inline">
                    <button type="submit"
                            th:class="${table.status == 'available'} ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'"
                            class="status-toggle w-10 h-10 rounded-xl flex items-center justify-center text-white text-sm transition-all">
                        <i th:class="${table.status == 'available'} ? 'fas fa-times' : 'fas fa-check'"></i>
                    </button>
                </form>
                <!-- View Order Button (only if table is occupied) -->
                <button th:if="${table.status == 'occupied'}"
                        th:attr="onclick='showOrderModal(\'' + ${table.tableNumber} + '\')'"
                        class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center hover:bg-blue-600 text-white text-sm transition-all">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>
    </div>
    <!-- Notification Popup: Fixed position, responsive -->
    <div id="notification" class="notification">
        <i class="fas fa-bell mr-2"></i>
        <span id="notification-text"></span>
        <button id="confirmButton" class="ml-4 bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Đồng ý</button>
    </div>

    <!-- Empty State: Center on mobile -->
    <div th:if="${#lists.isEmpty(tables)}" class="text-center py-12">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-table text-gray-400 text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Chưa có bàn nào</h3>
        <p class="text-gray-500 text-sm">Liên hệ admin để tạo bàn mới</p>
    </div>
</main>

<!-- QR Code Modal: Full screen on mobile -->
<div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Mã QR bàn</h3>
            <button onclick="hideQR()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="text-center">
            <img id="qrImage" src="" alt="QR Code" class="w-48 h-48 mx-auto mb-4 rounded-xl shadow-lg border-4 border-gray-100">
            <p class="text-sm text-gray-500">Khách hàng quét mã này để đặt món</p>
        </div>
    </div>
</div>
<!-- Order Modal: Cập nhật để hiển thị order, chỉnh sửa, và thanh toán -->
<div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md max-h-96 overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Chi tiết Order - Bàn <span id="modalTableNumber"></span></h3>
            <button onclick="hideOrderModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="orderDetails">
            <!-- Nội dung order sẽ được load qua JS -->
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                <p class="text-gray-500 mt-2">Đang tải...</p>
            </div>
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button onclick="saveOrderChanges()" class="bg-blue-500 text-white px-4 py-2 rounded-xl hover:bg-blue-600 transition-all">Lưu thay đổi</button>
            <button onclick="payOrder()" class="bg-green-500 text-white px-4 py-2 rounded-xl hover:bg-green-600 transition-all">Thanh toán</button>
        </div>
    </div>
</div>


<!-- Footer: Fixed bottom -->
<footer class="bg-white border-t fixed bottom-0 w-full max-w-screen-sm mx-auto">
    <div class="px-4 py-3">
        <div class="flex justify-between items-center text-sm text-gray-500">
            <span>LumiScan Employee</span>
            <a href="/logout" class="text-red-500 hover:text-red-700 flex items-center">
                <i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất
            </a>
        </div>
    </div>
</footer>

<!-- JavaScript: WebSocket và functions -->
<script>
    let stompClient = null;
    let currentOrder = null;

    // Kết nối WebSocket khi trang load
    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected to WebSocket: ' + frame);
            // Subscribe để nhận thông báo order mới
            stompClient.subscribe('/topic/orders', function (message) {
                console.log('Received message: ' + message.body);
                const notificationText = message.body;
                showNotification(notificationText);
                // Extract tableNumber từ message (e.g., "New order from table 1 - Order ID: 123")
                const tableMatch = notificationText.match(/table (\w+)/);
                if (tableMatch) {
                    highlightTable(tableMatch[1]);
                }
            });
        }, function (error) {
            console.error('WebSocket error: ', error);
            setTimeout(connect, 5000); // Retry
        });
    }

    // Hiển thị notification
    function showNotification(text) {
        const notif = document.getElementById('notification');
        document.getElementById('notification-text').textContent = text;
        notif.style.display = 'block';
        setTimeout(() => notif.style.display = 'none', 5000);
    }

    // Highlight bàn có order mới
    function highlightTable(tableNumber) {
        const tableElement = document.getElementById('table-' + tableNumber);
        if (tableElement) {
            tableElement.classList.add('highlight');
            setTimeout(() => tableElement.classList.remove('highlight'), 10000);
        }
    }

    // Ngắt kết nối khi unload
    window.addEventListener('beforeunload', function() {
        if (stompClient) {
            stompClient.disconnect();
        }
    });

    // Khởi tạo kết nối
    connect();

    // Functions cho QR modal
    function showQR(qrPath) {
        // Ensure path starts with / if it doesn't
        const fullPath = qrPath.startsWith('/') ? qrPath : '/' + qrPath;
        document.getElementById('qrImage').src = fullPath;
        document.getElementById('qrImage').onerror = function() {
            console.error('Failed to load QR code:', fullPath);
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5Y2EzYWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBDb2RlPC90ZXh0Pjwvc3ZnPg==';
        };
        document.getElementById('qrModal').classList.remove('hidden');
    }

    function hideQR() {
        document.getElementById('qrModal').classList.add('hidden');
    }

    // Function hiển thị order modal
    function showOrderModal(tableNumber) {
        // Fetch order data from server
        fetch('/order/table/' + tableNumber)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.order) {
                    currentOrder = data.order;
                    displayOrderDetails(data.order);
                    document.getElementById('modalTableNumber').textContent = tableNumber;
                    document.getElementById('orderModal').classList.remove('hidden');
                } else {
                    alert('Không tìm thấy đơn hàng cho bàn này');
                }
            })
            .catch(error => {
                console.error('Error fetching order:', error);
                alert('Lỗi khi tải đơn hàng');
            });
    }

    // Function hiển thị chi tiết order
    function displayOrderDetails(order) {
        const detailsDiv = document.getElementById('orderDetails');
        let html = `<div class="space-y-2">`;
        let total = 0;
        
        if (order.items && order.items.length > 0) {
            html += `<ul class="list-none space-y-2">`;
            order.items.forEach(item => {
                const itemPrice = parseFloat(item.menuItem.price) || parseFloat(item.price) || 0;
                const quantity = parseInt(item.quantity) || 0;
                const itemTotal = itemPrice * quantity;
                total += itemTotal;
                html += `
                    <li class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${item.menuItem.name || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${itemPrice.toLocaleString('vi-VN')} VND x ${quantity}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="number" 
                                   value="${quantity}" 
                                   min="1" 
                                   onchange="updateItemQuantity(${item.id}, this.value)"
                                   class="w-16 px-2 py-1 border rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="font-bold text-red-600 w-20 text-right">${itemTotal.toLocaleString('vi-VN')} VND</span>
                        </div>
                    </li>
                `;
            });
            html += `</ul>`;
        } else {
            html += `<p class="text-gray-500 text-center py-4">Chưa có món nào trong đơn hàng</p>`;
        }
        html += `<div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-700">Tổng cộng:</span>
                        <span class="font-bold text-lg text-red-600">${total.toLocaleString('vi-VN')} VND</span>
                    </div>
                 </div>`;
        html += `</div>`;
        detailsDiv.innerHTML = html;
    }
    // Function cập nhật quantity trong currentOrder
    function updateItemQuantity(itemId, newQuantity) {
        const item = currentOrder.items.find(i => i.id === itemId);
        if (item) {
            item.quantity = parseInt(newQuantity);
        }
    }
    // Function thanh toán
    function payOrder() {
        if (!currentOrder) {
            alert('Không có đơn hàng để thanh toán');
            return;
        }
        
        if (!confirm('Bạn có chắc chắn muốn thanh toán đơn hàng này?')) {
            return;
        }
        
        fetch('/order/pay/' + currentOrder.id, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Thanh toán thành công! Bàn đã được giải phóng.');
                    hideOrderModal();
                    location.reload(); // Reload để cập nhật status bàn
                } else {
                    alert('Lỗi: ' + (data.message || 'Không thể thanh toán'));
                }
            })
            .catch(error => {
                console.error('Error paying:', error);
                alert('Có lỗi xảy ra khi thanh toán. Vui lòng thử lại.');
            });
    }

        // Save changes
    function saveOrderChanges() {
        const request = {
            orderId: currentOrder.id,
            items: currentOrder.items.map(item => ({ menuItemId: item.menuItem.id, quantity: item.quantity }))
        };
        fetch('/order/update-items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(request)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Cập nhật thành công');
                hideOrderModal();
                // Optional: Reload page hoặc update UI
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error saving:', error));
    }
    function hideOrderModal() {
        document.getElementById('orderModal').classList.add('hidden');
    }
</script>
</body>
</html>
