<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản lý bàn - LumiScan</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome cho icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SockJS và STOMP.js cho WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <audio id="notificationSound" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" preload="auto"></audio> <!-- Thay bằng file âm thanh của bạn -->
    <style>
        /* Custom styles cho mobile và animations */
        .table-card {
            transition: all 0.3s ease;
        }
        .table-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .status-toggle {
            transition: all 0.3s ease;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            max-width: 80vw; /* Responsive trên mobile */
            word-wrap: break-word;
        }
        .highlight {
            border: 2px solid #ef4444;
            background-color: #fef2f2;
            animation: pulse 1s infinite; /* Animation cho highlight */
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        /* Mobile-specific: Ensure buttons are touch-friendly */
        button, .table-card {
            min-height: 44px; /* iOS touch target */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
<!-- Header: Sticky, responsive -->
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="px-4 py-3 max-w-screen-sm mx-auto"> <!-- Center on mobile -->
        <div class="flex justify-between items-center">
            <div class="flex items-center">
                <a href="/dashboard" class="mr-3 p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-arrow-left text-indigo-600 text-lg"></i>
                </a>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Quản lý bàn</h1>
                    <p class="text-xs text-gray-500">Nhân viên: <span th:text="${#authentication.name}">User</span></p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="text-right">
                    <div class="text-sm font-semibold text-gray-800" th:text="${activeTables}">0</div>
                    <div class="text-xs text-gray-500">Bàn hoạt động</div>
                </div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content: Responsive grid và list -->
<main class="px-4 py-4 max-w-screen-sm mx-auto pb-20"> <!-- Padding bottom cho footer -->
    <!-- Stats Cards: Grid responsive -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-white rounded-lg p-4 shadow-sm table-card">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-table text-blue-600"></i>
                </div>
                <div>
                    <div class="text-lg font-bold text-gray-800" th:text="${totalTables}">0</div>
                    <div class="text-xs text-gray-500">Tổng bàn</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg p-4 shadow-sm table-card">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-check-circle text-green-600"></i>
                </div>
                <div>
                    <div class="text-lg font-bold text-gray-800" th:text="${activeTables}">0</div>
                    <div class="text-xs text-gray-500">Đang hoạt động</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables List: Vertical stack, touch-friendly -->
    <div class="space-y-3">
        <div th:each="table : ${tables}" class="table-card bg-white rounded-lg p-4 shadow-sm" th:id="'table-' + ${table.tableNumber}">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 flex-1">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center mr-4"
                         th:class="${table.status == 'available'} ? 'bg-green-100' : 'bg-red-100'">
                        <i th:class="${table.status == 'available'} ? 'fas fa-check text-green-600' : 'fas fa-times text-red-600'"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-800" th:text="'Bàn ' + ${table.tableNumber}">Bàn 1</h3>
                        <p class="text-sm text-gray-500" th:text="${table.status == 'available'} ? 'Có sẵn' : 'Đã sử dụng'">Có sẵn</p>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <!-- QR Code Button: Modal trigger -->
                    <button onclick="showQR('[[${table.qrCodePath}]]')"
                            class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center hover:bg-indigo-200">
                        <i class="fas fa-qrcode text-indigo-600 text-sm"></i>
                    </button>

                    <!-- Toggle Status Button: Form submit -->
                    <form th:action="@{/tables/toggle/{id}(id=${table.id})}" method="post" class="inline">
                        <button type="submit"
                                th:class="${table.status == 'available'} ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'"
                                class="status-toggle w-10 h-10 rounded-lg flex items-center justify-center text-white text-sm">
                            <i th:class="${table.status == 'available'} ? 'fas fa-times' : 'fas fa-check'"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Popup: Fixed position, responsive -->
    <div id="notification" class="notification">
        <i class="fas fa-bell mr-2"></i>
        <span id="notification-text"></span>
        <button id="confirmButton" class="ml-4 bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Đồng ý</button>
    </div>

    <!-- Empty State: Center on mobile -->
    <div th:if="${#lists.isEmpty(tables)}" class="text-center py-12">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-table text-gray-400 text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Chưa có bàn nào</h3>
        <p class="text-gray-500 text-sm">Liên hệ admin để tạo bàn mới</p>
    </div>
</main>

<!-- QR Code Modal: Full screen on mobile -->
<div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Mã QR bàn</h3>
            <button onclick="hideQR()" class="text-gray-400 hover:text-gray-600 p-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="text-center">
            <img id="qrImage" src="" alt="QR Code" class="w-48 h-48 mx-auto mb-4 rounded-lg shadow-sm">
            <p class="text-sm text-gray-500">Khách hàng quét mã này để đặt món</p>
        </div>
    </div>
</div>
<div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-96 overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Chi tiết Order - Bàn <span id="modalTableNumber"></span></h3>
            <button onclick="hideOrderModal()" class="text-gray-400 hover:text-gray-600 p-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="orderDetails">
            <!-- Nội dung order sẽ được load qua JS -->
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button onclick="saveOrderChanges()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Lưu thay đổi</button>
        </div>
    </div>
</div>


<!-- Footer: Fixed bottom -->
<footer class="bg-white border-t fixed bottom-0 w-full max-w-screen-sm mx-auto">
    <div class="px-4 py-3">
        <div class="flex justify-between items-center text-sm text-gray-500">
            <span>LumiScan Employee</span>
            <a href="/logout" class="text-red-500 hover:text-red-700 flex items-center">
                <i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất
            </a>
        </div>
    </div>
</footer>

<!-- JavaScript: WebSocket và functions -->
<script>
    let stompClient = null;

    // Kết nối WebSocket khi trang load
    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected to WebSocket: ' + frame);
            // Subscribe để nhận thông báo order mới
            stompClient.subscribe('/topic/orders', function (message) {
                console.log('Received message: ' + message.body);
                const notificationText = message.body;
                showNotification(notificationText);
                // Extract tableNumber từ message (e.g., "New order from table 1 - Order ID: 123")
                const tableMatch = notificationText.match(/table (\w+)/);
                if (tableMatch) {
                    highlightTable(tableMatch[1]);
                }
            });
        }, function (error) {
            console.error('WebSocket error: ', error);
            setTimeout(connect, 5000); // Retry
        });
    }

    // Hiển thị notification
    function showNotification(text) {
        const notif = document.getElementById('notification');
        document.getElementById('notification-text').textContent = text;
        notif.style.display = 'block';
        setTimeout(() => notif.style.display = 'none', 5000);
    }

    // Highlight bàn có order mới
    function highlightTable(tableNumber) {
        const tableElement = document.getElementById('table-' + tableNumber);
        if (tableElement) {
            tableElement.classList.add('highlight');
            setTimeout(() => tableElement.classList.remove('highlight'), 10000);
        }
    }

    // Ngắt kết nối khi unload
    window.addEventListener('beforeunload', function() {
        if (stompClient) {
            stompClient.disconnect();
        }
    });

    // Khởi tạo kết nối
    connect();

    // Functions cho QR modal
    function showQR(qrPath) {
        document.getElementById('qrImage').src = qrPath;
        document.getElementById('qrModal').classList.remove('hidden');
    }

    function hideQR() {
        document.getElementById('qrModal').classList.add('hidden');
    }
        // Save changes
    function saveOrderChanges() {
        const request = {
            orderId: currentOrder.id,
            items: currentOrder.items.map(item => ({ menuItemId: item.menuItem.id, quantity: item.quantity }))
        };
        fetch('/order/update-items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(request)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Cập nhật thành công');
                hideOrderModal();
                // Optional: Reload page hoặc update UI
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error saving:', error));
    }
    function hideOrderModal() {
        document.getElementById('orderModal').classList.add('hidden');
    }
</script>
</body>
</html>
