<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Đặt món</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .menu-item { transition: all 0.3s ease; }
        .menu-item:hover { transform: translateY(-2px); }
        .cart-item { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<!-- Header -->
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="px-4 py-3">
        <div class="flex justify-between items-center">
            <div class="flex items-center">
                <a href="/" class="mr-3">
                    <i class="fas fa-arrow-left text-indigo-600 text-lg"></i>
                </a>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Bàn <span th:text="${tableNumber}">1</span></h1>
                    <p class="text-xs text-gray-500">Chọn món và đặt hàng</p>
                </div>
            </div>
            <div class="relative">
                <button onclick="toggleCart()" class="relative">
                    <i class="fas fa-shopping-cart text-indigo-600 text-lg"></i>
                    <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="pb-20">
    <!-- Table Status -->
    <div class="px-4 py-3 bg-white border-b">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                <span class="text-sm text-gray-600">Bàn đang hoạt động</span>
            </div>
            <span class="text-sm text-gray-500">Cập nhật: <span id="lastUpdate">vừa xong</span></span>
        </div>
    </div>

    <!-- Menu Categories -->
    <div class="px-4 py-3 bg-white border-b">
        <div class="flex space-x-4 overflow-x-auto">
            <button class="category-btn px-4 py-2 bg-indigo-600 text-white rounded-full text-sm whitespace-nowrap"
                    data-category="all">
                Tất cả
            </button>

            <!-- Load categories dynamically -->
            <th:block th:each="cat : ${categories}">
                <button class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm whitespace-nowrap"
                        th:attr="data-category=${cat.id}"
                        th:text="${cat.name}">
                </button>
            </th:block>
        </div>
    </div>

    <!-- Menu Items -->
    <div class="px-4 py-3 space-y-3 bg-gray-50">
        <div th:each="item : ${menuItems}"
             class="menu-item bg-white rounded-lg p-4 shadow-sm"
             th:attr="data-category=${item != null and item.category != null ? item.category.id : 0}">

            <div class="flex items-center justify-between">
                <div class="w-20 h-20 flex-shrink-0 mr-4">
                    <img th:src="@{${item.imageUrl}}" alt="Ảnh món ăn"
                         class="w-full h-full object-cover rounded-lg shadow-sm">
                </div>

                <div class="flex-1">
                    <h3 class="font-semibold text-gray-800" th:text="${item.name}">Tên món</h3>
                    <p class="text-sm text-gray-500 mt-1" th:text="${item.description}">Mô tả món ăn</p>

                    <div class="flex items-center mt-2">
                    <span class="text-lg font-bold text-indigo-600"
                          th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + 'đ'">0đ</span>

                        <span class="ml-2 text-xs text-green-600 bg-green-100 px-2 py-1 rounded"
                              th:if="${item.status?.name() == 'available'}">Có sẵn</span>

                        <span class="ml-2 text-xs text-red-600 bg-red-100 px-2 py-1 rounded"
                              th:unless="${item.status?.name() == 'available'}">Hết hàng</span>
                    </div>
                </div>
                <div class="flex items-center mt-3">
                    <button th:attr="onclick=|addToCart(${item.id})|"
                            class="bg-indigo-600 text-white text-sm px-3 py-1 rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-cart-plus mr-1"></i>
                    </button>

                </div>
            </div>
        </div>

    </div>

</main>

<!-- Cart Bottom Sheet -->
<div id="cartSidebar"
     class="fixed inset-x-0 bottom-0 z-50 bg-white rounded-t-2xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-in-out">

    <!-- Header -->
    <div class="p-4 border-b flex justify-between items-center">
        <h3 class="text-lg font-semibold">Giỏ hàng</h3>
        <button onclick="toggleCart()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Cart Content -->
    <div class="overflow-y-auto p-4" style="max-height: 50vh;">
        <div id="cartItems" class="space-y-3">
            <!-- Cart items sẽ được thêm bằng JS -->
        </div>
    </div>

    <!-- Footer -->
    <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
        <div>
            <span class="text-sm text-gray-600">Tổng cộng:</span>
            <p id="totalPrice" class="text-lg font-bold text-indigo-600">0đ</p>
        </div>
        <button onclick="placeOrder()"
                class="bg-indigo-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
            Xác nhận
        </button>
    </div>
</div>

<!-- Floating Cart Button -->
<div class="fixed bottom-4 right-4 z-40">
    <button onclick="toggleCart()"
            class="w-14 h-14 bg-indigo-600 rounded-full shadow-lg flex items-center justify-center relative">
        <i class="fas fa-shopping-cart text-white text-lg"></i>
        <span id="floatingCartCount"
              class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
    </button>
</div>

<!-- JavaScript (giữ nguyên) -->
<script th:inline="javascript">
    let cart = {}; // Lưu tạm các món trong giỏ hàng
    let totalPrice = 0;
    const tableNumber = /*[[${tableNumber}]]*/ 1; // Lấy số bàn từ Thymeleaf

    // --- Bộ lọc theo danh mục ---
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const category = this.dataset.category;

                document.querySelectorAll('.category-btn').forEach(b => {
                    b.className = 'category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm whitespace-nowrap';
                });
                this.className = 'category-btn px-4 py-2 bg-indigo-600 text-white rounded-full text-sm whitespace-nowrap';

                document.querySelectorAll('.menu-item').forEach(item => {
                    if (category === 'all' || item.dataset.category === category) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });
    });

    // --- Thêm món vào giỏ ---
    function addToCart(itemId) {
        if (!cart[itemId]) cart[itemId] = 0;
        cart[itemId]++;
        updateCartDisplay();
    }

    // --- Cập nhật số lượng ---
    function increaseQuantity(itemId) {
        cart[itemId]++;
        updateCartDisplay();
    }

    function decreaseQuantity(itemId) {
        if (cart[itemId] > 1) {
            cart[itemId]--;
        } else {
            delete cart[itemId];
        }
        updateCartDisplay();
    }

    // --- Cập nhật hiển thị giỏ hàng ---
    function updateCartDisplay() {
        const cartCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
        document.getElementById('cartCount').textContent = cartCount;
        document.getElementById('floatingCartCount').textContent = cartCount;

        const cartItems = document.getElementById('cartItems');
        cartItems.innerHTML = '';
        totalPrice = 0;

        Object.keys(cart).forEach(itemId => {
            const itemElement = document.querySelector(`[onclick*="${itemId}"]`).closest('.menu-item');
            const name = itemElement.querySelector('h3').textContent;
            const price = parseInt(itemElement.querySelector('.text-indigo-600').textContent.replace(/[^\d]/g, ''));
            const quantity = cart[itemId];
            totalPrice += price * quantity;

            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item bg-white rounded-lg p-3 shadow-sm';
            cartItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex-1">
                        <h4 class="font-semibold text-sm">${name}</h4>
                        <p class="text-xs text-gray-500">${price.toLocaleString()}đ</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="decreaseQuantity('${itemId}')" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center">
                            <i class="fas fa-minus text-gray-600 text-xs"></i>
                        </button>
                        <span class="w-6 text-center text-sm font-semibold">${quantity}</span>
                        <button onclick="increaseQuantity('${itemId}')" class="w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-plus text-white text-xs"></i>
                        </button>
                    </div>
                </div>
            `;
            cartItems.appendChild(cartItem);
        });

        document.getElementById('totalPrice').textContent = totalPrice.toLocaleString() + 'đ';
    }

    // --- Mở / đóng giỏ hàng ---
    function toggleCart() {
        const cartSidebar = document.getElementById('cartSidebar');
        const isHidden = cartSidebar.classList.contains('translate-y-full');
        if (isHidden) {
            cartSidebar.classList.remove('translate-y-full');
            cartSidebar.classList.add('translate-y-0');
        } else {
            cartSidebar.classList.remove('translate-y-0');
            cartSidebar.classList.add('translate-y-full');
        }
    }

    // --- Gửi đơn hàng lên server ---
    async function placeOrder() {
        if (Object.keys(cart).length === 0) {
            alert('Vui lòng chọn món trước khi đặt hàng!');
            return;
        }

        const orderData = {
            tableNumber: tableNumber,
            items: cart
        };

        try {
            const response = await fetch('/order/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                const result = await response.json();
                alert(result.message || 'Đặt món thành công!');
                cart = {};
                updateCartDisplay();
                toggleCart();
            } else {
                alert('Có lỗi khi gửi đơn hàng!');
            }
        } catch (error) {
            console.error(error);
            alert('Không thể kết nối đến server.');
        }
    }

    // --- Cập nhật thời gian ---
    setInterval(() => {
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }, 30000);
</script>

</body>
</html>
